name: Deploy Stage

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Release tag to deploy (e.g., v0.0.1)"
        required: true

permissions:
  contents: read

concurrency:
  group: deploy-stage
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stage
    timeout-minutes: 15
    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts || true

      - name: Deploy to stage
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          REPO: ${{ github.repository }}
        run: |
          echo "ğŸš€ Deploying ${IMAGE_TAG} to stage"

          # SSH and deploy
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << EOF
            set -e
            cd $DEPLOY_PATH
            
            echo "ğŸ“¦ Pulling image: ghcr.io/${REPO}/backend:${IMAGE_TAG}"
            docker pull ghcr.io/${REPO}/backend:${IMAGE_TAG}
            docker tag ghcr.io/${REPO}/backend:${IMAGE_TAG} forecaster-backend:latest
            
            echo "ğŸ”„ Stopping old containers..."
            docker compose down || true
            
            echo "ğŸš€ Starting containers..."
            docker compose up -d
            
            echo "â³ Waiting for backend to be ready (ML deps may install on first run, up to 5 min)..."
            # Wait up to 6 minutes (health check start_period is 5 min)
            MAX_WAIT=360
            ELAPSED=0
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              if curl -sf http://localhost:8000/ready > /dev/null 2>&1; then
                echo "âœ… Backend is ready!"
                break
              fi
              echo "   Still waiting... ($ELAPSED/$MAX_WAIT seconds)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done
            
            # Final check
            if curl -sf http://localhost:8000/ready > /dev/null 2>&1; then
              echo "âœ… Stage deployment successful!"
              echo "ğŸ“Š Backend logs (last 20 lines):"
              docker compose logs --tail=20 backend
            else
              echo "âŒ Health check failed after $MAX_WAIT seconds"
              echo "ğŸ“Š Backend logs:"
              docker compose logs backend
              exit 1
            fi
          EOF
