name: Deploy Stage

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Release tag to deploy (e.g., v0.0.1)"
        required: true

permissions:
  contents: read

concurrency:
  group: deploy-stage
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stage
    timeout-minutes: 15
    steps:
      - name: Deploy to stage
        run: |
          echo "ðŸš€ Deploying ${{ inputs.image_tag }} to stage"

          # SSH and deploy
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd $DEPLOY_PATH
            echo "Pulling: ghcr.io/$GITHUB_REPOSITORY/backend:${{ inputs.image_tag }}"
            docker pull ghcr.io/$GITHUB_REPOSITORY/backend:${{ inputs.image_tag }}
            docker tag ghcr.io/$GITHUB_REPOSITORY/backend:${{ inputs.image_tag }} forecaster-backend:latest
            docker compose down || true
            docker compose up -d
            sleep 15
            curl -f http://localhost:8000/ready || (echo "âŒ Health check failed" && exit 1)
            echo "âœ… Stage deployment successful!"
          EOF
